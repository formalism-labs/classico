#!/usr/bin/env bash

PROGNAME="${BASH_SOURCE[0]}"
HERE="$(cd "$(dirname "$PROGNAME")" &>/dev/null && pwd)"
CLASSICO=$(cd $HERE/.. && pwd)
. $CLASSICO/shibumi/defs

VERSION=${VERSION:-"1.13.3"}

OS=$(platform_os)
if [[ $OS == linux ]]; then
	OS=linux
elif [[ $OS == macos ]]; then
	OS=darwin
elif [[ $OS == freebsd ]]; then
	OS=freebsd
elif [[ $OS ==  ]]; then
	OS=openbsd
elif [[ $OS == SunOS ]]; then
	OS=solaris
else
	echo "$OS: unsupported"
fi

ARCH=$(platform_arch)
if [[ $ARCH == x64 ]]; then
	ARCH=amd64
elif [[ $ARCH == x86 ]]; then
	ARCH=386
elif [[ $ARCH == arm64v8 ]]; then
	ARCH=arm64
elif [[ $ARCH == arm32v7 ]]; then
	ARCH=arm
else
	echo "$ARCH: unsupported"
	exit 1
fi

dir=$(mktemp -d /tmp/tf.XXXXXX)
wget -q -O $dir/tf.zip https://releases.hashicorp.com/terraform/${VERSION}/terraform_${VERSION}_${OS}_${ARCH}.zip
cd $dir
unzip -q tf.zip
chmod +x terraform
mv terraform $HOME/.local/bin/
cd $HERE
rm -rf $dir
