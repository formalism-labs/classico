#!/usr/bin/env bash

PROGNAME="${BASH_SOURCE[0]}"
HERE="$(cd "$(dirname "$PROGNAME")" &>/dev/null && pwd)"
CLASSICO=$(cd $HERE/.. && pwd)
. $CLASSICO/shibumi/defs

os=$(platform_os)
if [[ -f /etc/os-release ]]; then
	dist=$(source /etc/os-release; echo "${ID}")
	osver=$(source /etc/os-release; echo "${VERSION_ID}")
fi
arch=$(uname -m)

packs="ca-certificates wget curl unzip gzip xz"

if is_command apt-get; then
	packs="${packs/xz/xz-utils}"
elif is_command yum; then
	packs+=" tar"
elif is_command brew; then
	packs="${packs/ca-certificates/}"
fi

if [[ $dist == rocky || $dist == almalinux || $dist == rhel ]]; then
    xinstall bc

	# has curl-minimal which conflicts with curl
	if [[ $(echo "$osver >= 9.0" | bc -l) ]]; then
		packs="${packs/curl/}"
	fi
elif [[ $dist == fedora || $dist == mariner ]]; then
	packs+=" awk"
fi

if [[ $os == windows ]]; then
	packs="${packs/ca-certificates/}"
fi

if [[ $FORCE != 1 ]]; then
	missing=0
	for cmd in ${packs/ca-certificates/}; do
		if ! is_command $cmd; then
			missing=1
			break
		fi
	done
else
    missing=1
fi

if [[ $missing == 1 ]]; then
    xinstall $packs
fi

if [[ $os == windows ]]; then
    posh "& \$CLASSICO/bin/getget.ps1"
fi
exit 0
