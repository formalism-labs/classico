#!/usr/bin/env bash

PROGNAME="${BASH_SOURCE[0]}"
HERE="$(cd "$(dirname "$PROGNAME")" &>/dev/null && pwd)"
CLASSICO="$(cd $HERE/.. && pwd)"
. $CLASSICO/shibumi/defs

# export DEBIAN_FRONTEND=noninteractive

#----------------------------------------------------------------------------------------------

if [[ $1 == --help || $1 == help || $HELP == 1 ]]; then
	cat <<-'END'
		[ARGVARS...] getruby [--help|help]

		Argument variables:
		VERSION=ver   Use specific Ruby version
		GEMS=dir      Install gems in `dir`
		FORCE=1       Install even if present
		VERBOSE=n     Verbosity level (1: print commands, 2: print results)
		NOP=1         Print commands, don't execute
		HELP=1        Print help

	END
	exit 0
fi

note() {
	if (( VERBOSE >= 1 )); then
		echo "# $@"
	fi
}

#----------------------------------------------------------------------------------------------

install_rv() {
	if [[ ! -f $HOME/.local/bin/rv ]]; then
		runn "curl --proto '=https' --tlsv1.2 -LsSf https://github.com/spinel-coop/rv/releases/download/v0.2.0/rv-installer.sh | CARGO_HOME=~/.local sh"
	fi
}

ruby_rearm() {
	runn bundler install --gemfile $CLASSICO/bento/Gemfile
}

#----------------------------------------------------------------------------------------------

OP=""
[[ $NOP == 1 ]] && OP=echo

#----------------------------------------------------------------------------------------------

os="$(platform_os)"
if [[ $os == windows ]]; then
	wintype="$(platform_windows)"
fi

arch="$(platform_arch)"

if [[ -f /etc/os-release ]]; then
	dist="$(source /etc/os-release; echo "${ID}")"
	distver="$(source /etc/os-release; echo "${VERSION_ID}")"
	distx="$(source /etc/os-release; echo "${ID}${VERSION_ID}")"
fi

#----------------------------------------------------------------------------------------------

RUBY_VER="${VERSION:-3.4.7}"
RV_DIR="$HOME/.data/rv"
GEMS_DIR="${GEMS_DIR:-$HOME/.gems}"

#----------------------------------------------------------------------------------------------

if [[ $FORCE == 1 ]]; then
	rm -rf $RV_DIR $GEMS_DIR
fi

install_rv

if is_command ruby; then
	ver="$(ruby --version | cut -f2 -d" ")"
	vercmp="$(compare_versions "$ver" "$RUBY_VER")"
	if (( vercmp < 0 )); then
		if [[ -d $GEMS_DIR ]]; then
			rm -rf $GEMS_DIR
		fi
	fi
fi

if [[ -d $GEMS_DIR ]]; then
	eprint "Ruby already installed. Rearming."
	ruby_rearm
	exit 0
fi

if ! is_command rv; then
	$OP eval "$(rv shell init bash)"
fi
if ! is_command ruby; then
	runn rv ruby install $RUBY_VER
fi
if ! is_command bundler; then
	runn gem install bundler
fi

profile_d="$(get_profile_d)"

cat <<-END > $profile_d/ruby.sh
	eval "\$(rv shell init bash)"
	eval "\$(rv shell completions bash)"
	
	export GEM_HOME=$HOME/.gems
	prepend_to_var GEM_PATH \$GEM_HOME
	
	export RUBYLIB=$CLASSICO/bento
	END

rearm
mkdir -p $GEM_HOME
runn bundler install --gemfile=$CLASSICO/bento/Gemfile

exit 0
